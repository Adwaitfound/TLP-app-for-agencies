# Azure Deployment Plan for video-production-app

## Goal

Deploy the Next.js web application to Azure using Azure Developer CLI (azd) and Azure App Service for Linux, with Application Insights and Log Analytics for monitoring. Supabase remains an external dependency configured via environment variables.

## Project Information

- App Name: video-production-app
- Stack: Next.js 16 (React 19), TypeScript, Node 20
- Type: Web application (SSR/Edge not required), single service
- Containerization: Not required (App Service for Linux runs Node directly). Can be containerized later if needed.
- Dependencies: External Supabase (auth + DB + storage)
- Hosting: Azure App Service (Linux, Node 20)

## Azure Resources Architecture

```mermaid
graph TD
  subgraph "Compute Resources"
    azureappservice_web["`web (Azure App Service, Linux, Node 20)`"]
  end
  subgraph "Dependency Resources"
    external_supabase["`Supabase (External)`"]
    appinsights["`Application Insights`"]
    loganalytics["`Log Analytics Workspace`"]
  end

  azureappservice_web -.-> |Uses| external_supabase
  azureappservice_web --> |Sends telemetry| appinsights
  appinsights --> |Stores logs| loganalytics
```

- The web app (App Service) hosts the Next.js app.
- The web app consumes Supabase via env vars: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY.
- Application Insights collects telemetry; Log Analytics stores logs/queries.

## Recommended Azure Resources

Application: video-production-app

- Hosting Service: Azure App Service (Linux) on an App Service Plan
  - Recommended SKU: B1 (Basic) for dev/testing; consider P1v3 for production scale/performance
  - Configuration:
    - language: nodejs (Node 20)
    - App Settings (Environment Variables):
      - NEXT_PUBLIC_SUPABASE_URL
      - NEXT_PUBLIC_SUPABASE_ANON_KEY
      - SUPABASE_SERVICE_ROLE_KEY (server-only)
      - NODE_ENV=production
      - PORT=8080 (App Service default is 8080; next start will bind accordingly)
- Dependencies (External):
  - Supabase (External SaaS)
    - Connection Type: HTTP API keys
    - Environment Variables: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
- Supporting Services:
  - Application Insights (Standard)
  - Log Analytics Workspace (PerGB2018)
  - Optional: Key Vault to store SUPABASE_SERVICE_ROLE_KEY and reference from App Service (recommended for production). For this plan we will set via azd env/app settings.

## Recommended Security Configurations

- Do not expose SUPABASE_SERVICE_ROLE_KEY to client. Ensure it's only referenced server-side.
- If Key Vault is enabled later, assign a User-Assigned Managed Identity to App Service and grant get/list permissions for the secret.
- Restrict CORS in Supabase to your Azure App Service hostname(s).

## Execution Steps

> Copilot will follow these steps; you can ask it to execute them.

1. Create Azure Infrastructure Files for AZD

- Expected files: azure.yaml, infra/main.bicep, infra/main.parameters.json
- If missing, Copilot will generate them (Bicep targeting: App Service Plan + App Service + App Insights + Log Analytics).

2. Env Setup for azd

- Install Azure CLI and Azure Developer CLI if missing.
- Create environment:
  - azd env new <envName> --no-prompt
- Set subscription and resource group:
  - az account show (to confirm active subscription)
  - azd env set AZURE_SUBSCRIPTION_ID <subscriptionId>
  - azd env set AZURE_RESOURCE_GROUP <resourceGroup>
  - azd env set AZURE_LOCATION <region>
- Set required application settings (values from you):
  - azd env set NEXT_PUBLIC_SUPABASE_URL <value>
  - azd env set NEXT_PUBLIC_SUPABASE_ANON_KEY <value>
  - azd env set SUPABASE_SERVICE_ROLE_KEY <value>

3. Provision + Deploy

- Dry run infra:
  - azd provision --preview --no-prompt
- Provision + deploy:
  - azd up --no-prompt
- If region changes are needed later, run azd down --force --no-prompt and re-run with updated env.

4. Validate Deployment

- Retrieve logs with Copilot tool and/or:
  - az webapp log tail -n <appName> -g <resourceGroup>
- Confirm app responds at the App Service default hostname.

5. Summarize Deployment Result

- Copilot will create .azure/summary.copilotmd capturing resources and output endpoints.

## Inputs Needed

- Azure Subscription ID (GUID)
- Preferred Azure Region (e.g., eastus, westeurope, centralindia)
- Resource Group name (existing or new; Copilot can create if needed)
- Values for:
  - NEXT_PUBLIC_SUPABASE_URL
  - NEXT_PUBLIC_SUPABASE_ANON_KEY
  - SUPABASE_SERVICE_ROLE_KEY (server-only)

## Progress Tracking

Copilot will update .azure/progress.copilotmd with:

- ‚úÖ Completed tasks
- üî≤ Pending tasks
- ‚ùå Failures and fixes
