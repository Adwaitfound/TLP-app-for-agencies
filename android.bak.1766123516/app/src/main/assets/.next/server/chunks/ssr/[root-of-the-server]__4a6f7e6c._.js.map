{"version":3,"sources":["../../../../app/actions/client-comments.ts","../../../../lib/audit.ts","../../../../.next-internal/server/app/dashboard/comments/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["'use server'\n\nimport { createServiceClient } from '@/lib/supabase/server'\nimport { logAuditEvent } from '@/lib/audit'\n\nasync function notifyUsers(userIds: string[], payload: { type: string, message: string, metadata?: Record<string, any> }) {\n    if (!userIds.length) return\n    const supabase = createServiceClient()\n    const { error } = await supabase.from('notifications').insert(\n        userIds.map((uid) => ({ user_id: uid, type: payload.type, message: payload.message, metadata: payload.metadata }))\n    )\n    if (error) console.warn('notifyUsers insert failed', error.message)\n}\n\nexport async function createProjectComment(params: {\n    projectId: string,\n    authorUserId: string,\n    text: string\n}) {\n    const { projectId, authorUserId, text } = params\n    try {\n        const supabase = createServiceClient()\n        const { data, error } = await supabase\n            .from('project_comments')\n            .insert({ project_id: projectId, user_id: authorUserId, comment_text: text })\n            .select(`id, project_id, user_id, comment_text, status, created_at, assigned_user_id`)\n            .single()\n\n        if (error) return { success: false, error: error.message }\n\n        // Fire-and-forget audit log for admins/PMs visibility\n        logAuditEvent(\n            'create',\n            'project_comment',\n            data.id,\n            authorUserId,\n            { project_id: projectId, comment_text: text }\n        )\n\n        // Notify all admins/PMs (in-app notification)\n        const { data: admins } = await supabase\n            .from('users')\n            .select('id')\n            .in('role', ['admin', 'project_manager'])\n\n        const adminIds = (admins || []).map((a: any) => a.id)\n        await notifyUsers(adminIds, {\n            type: 'comment_created',\n            message: `New comment on a project: ${text.slice(0, 80)}`,\n            metadata: { project_id: projectId, comment_id: data.id },\n        })\n        return { success: true, comment: data }\n    } catch (err: any) {\n        return { success: false, error: err?.message || 'Unexpected error creating comment' }\n    }\n}\n\nexport async function listProjectComments(projectId: string) {\n    try {\n        const supabase = createServiceClient()\n        const { data, error } = await supabase\n            .from('project_comments')\n            .select(`\n                id,\n                project_id,\n                user_id,\n                comment_text,\n                status,\n                created_at,\n                assigned_user_id,\n                author:user_id(full_name, email),\n                assignee:assigned_user_id(full_name, email)\n            `)\n            .eq('project_id', projectId)\n            .order('created_at', { ascending: false })\n        if (error) return { success: false, error: error.message }\n        return { success: true, comments: data || [] }\n    } catch (err: any) {\n        return { success: false, error: err?.message || 'Unexpected error listing comments' }\n    }\n}\n\nexport async function assignCommentToEmployee(params: { commentId: string, userId: string }) {\n    try {\n        const supabase = createServiceClient()\n        const { data, error } = await supabase\n            .from('project_comments')\n            .update({ assigned_user_id: params.userId })\n            .eq('id', params.commentId)\n            .select(`id, assigned_user_id, assignee:assigned_user_id(full_name, email)`)\n            .single()\n        if (error) return { success: false, error: error.message }\n\n        logAuditEvent(\n            'assign',\n            'project_comment',\n            params.commentId,\n            params.userId,\n            { assigned_user_id: params.userId }\n        )\n\n        // Notify admins/PMs and the assigned employee\n        const { data: admins } = await supabase\n            .from('users')\n            .select('id')\n            .in('role', ['admin', 'project_manager'])\n        const targetIds = new Set<string>((admins || []).map((a: any) => a.id))\n        if (params.userId) targetIds.add(params.userId)\n        await notifyUsers(Array.from(targetIds), {\n            type: 'comment_assigned',\n            message: 'A comment was assigned',\n            metadata: { comment_id: params.commentId, assigned_user_id: params.userId },\n        })\n        return { success: true, comment: data }\n    } catch (err: any) {\n        return { success: false, error: err?.message || 'Unexpected error assigning comment' }\n    }\n}\n\nexport async function clientApproveProject(params: { projectId: string }) {\n    try {\n        const supabase = createServiceClient()\n        const { error } = await supabase\n            .from('projects')\n            .update({ client_approved: true, client_approved_at: new Date().toISOString() })\n            .eq('id', params.projectId)\n        if (error) return { success: false, error: error.message }\n        return { success: true }\n    } catch (err: any) {\n        return { success: false, error: err?.message || 'Unexpected error approving project' }\n    }\n}\n\nexport async function adminApproveProject(params: { projectId: string }) {\n    try {\n        const supabase = createServiceClient()\n        const { error } = await supabase\n            .from('projects')\n            .update({ client_approved: true, client_approved_at: new Date().toISOString() })\n            .eq('id', params.projectId)\n        if (error) return { success: false, error: error.message }\n        return { success: true }\n    } catch (err: any) {\n        return { success: false, error: err?.message || 'Unexpected error approving project (admin)' }\n    }\n}\n","\"use server\"\n\nimport { createServiceClient } from '@/lib/supabase/server'\n\n// Server-side audit logging helper\nexport async function logAuditEvent(action: string, entity: string, entityId: string, userId: string, metadata?: any) {\n    // This is a placeholder for server-side audit logging\n    // In production, you would write to an audit_logs table\n    const supabase = createServiceClient()\n    await supabase.from('audit_logs').insert({\n        action,\n        entity_type: entity,\n        entity_id: entityId,\n        user_id: userId,\n        metadata: metadata || {}\n    })\n}\n","export {logAuditEvent as '4001860d967ff1d29143ee49c09c9bbdff4d1af8fb'} from 'ACTIONS_MODULE0'\nexport {assignCommentToEmployee as '405c5bdfe2a43767b9832e1c2375adb8b49762ba71'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":"wDAEA,EAAA,EAAA,CAAA,CAAA,oBCGO,eAAe,EAAc,CAAc,CAAE,CAAc,CAAE,CAAgB,CAAE,CAAc,CAAE,CAAc,EAGhH,IAAM,EAAW,CAAA,EAAA,EAAA,mBAAA,AAAmB,GACpC,OAAM,EAAS,IAAI,CAAC,cAAc,MAAM,CAAC,QACrC,EACA,YAAa,EACb,UAAW,EACX,QAAS,EACT,SAAU,GAAY,CAAC,CAC3B,EACJ,CDXA,eAAe,EAAY,CAAiB,CAAE,CAA0E,EACpH,GAAI,CAAC,EAAQ,MAAM,CAAE,OACrB,IAAM,EAAW,CAAA,EAAA,EAAA,mBAAmB,AAAnB,IACX,CAAE,OAAK,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,iBAAiB,MAAM,CACzD,EAAQ,GAAG,CAAC,AAAC,IAAS,CAAE,CAAH,OAAY,EAAK,KAAM,EAAQ,IAAI,CAAE,QAAS,EAAQ,OAAO,CAAE,SAAU,EAAQ,QAAQ,CAAC,CAAC,GAEhH,GAAO,QAAQ,IAAI,CAAC,4BAA6B,EAAM,OAAO,CACtE,CAEO,eAAe,EAAqB,CAI1C,EACG,GAAM,WAAE,CAAS,cAAE,CAAY,MAAE,CAAI,CAAE,CAAG,EAC1C,GAAI,CACA,IAAM,EAAW,CAAA,EAAA,EAAA,mBAAA,AAAmB,IAC9B,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EACzB,IAAI,CAAC,oBACL,MAAM,CAAC,CAAE,WAAY,EAAW,QAAS,EAAc,aAAc,CAAK,GAC1E,MAAM,CAAC,CAAC,2EAA2E,CAAC,EACpF,MAAM,GAEX,GAAI,EAAO,MAAO,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,EAGzD,EACI,SACA,kBACA,EAAK,EAAE,CACP,EACA,CAAE,WAAY,EAAW,aAAc,CAAK,GAIhD,GAAM,CAAE,KAAM,CAAM,CAAE,CAAG,MAAM,EAC1B,IAAI,CAAC,SACL,MAAM,CAAC,MACP,EAAE,CAAC,OAAQ,CAAC,QAAS,kBAAkB,EAEtC,EAAW,CAAC,GAAU,EAAA,AAAE,EAAE,GAAG,CAAC,AAAC,GAAW,EAAE,EAAE,EAMpD,OALA,MAAM,EAAY,EAAU,CACxB,KAAM,kBACN,QAAS,CAAC,0BAA0B,EAAE,EAAK,KAAK,CAAC,EAAG,IAAA,CAAK,CACzD,SAAU,CAAE,WAAY,EAAW,WAAY,EAAK,EAAE,AAAC,CAC3D,GACO,CAAE,SAAS,EAAM,QAAS,CAAK,CAC1C,CAAE,MAAO,EAAU,CACf,MAAO,CAAE,SAAS,EAAO,MAAO,GAAK,SAAW,mCAAoC,CACxF,CACJ,CAEO,eAAe,EAAoB,CAAiB,EACvD,GAAI,CACA,IAAM,EAAW,CAAA,EAAA,EAAA,mBAAA,AAAmB,IAC9B,MAAE,CAAI,CAAE,OAAK,CAAE,CAAG,MAAM,EACzB,IAAI,CAAC,oBACL,MAAM,CAAC,CAAC;;;;;;;;;;YAUT,CAAC,EACA,EAAE,CAAC,aAAc,GACjB,KAAK,CAAC,aAAc,CAAE,WAAW,CAAM,GAC5C,GAAI,EAAO,MAAO,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,EACzD,MAAO,CAAE,SAAS,EAAM,SAAU,GAAQ,EAAE,AAAC,CACjD,CAAE,MAAO,EAAU,CACf,MAAO,CAAE,SAAS,EAAO,MAAO,GAAK,SAAW,mCAAoC,CACxF,CACJ,CAEO,eAAe,EAAwB,CAA6C,EACvF,GAAI,CACA,IAAM,EAAW,CAAA,EAAA,EAAA,mBAAA,AAAmB,IAC9B,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EACzB,IAAI,CAAC,oBACL,MAAM,CAAC,CAAE,iBAAkB,EAAO,MAAM,AAAC,GACzC,EAAE,CAAC,KAAM,EAAO,SAAS,EACzB,MAAM,CAAC,CAAC,iEAAiE,CAAC,EAC1E,MAAM,GACX,GAAI,EAAO,MAAO,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,EAEzD,EACI,SACA,kBACA,EAAO,SAAS,CAChB,EAAO,MAAM,CACb,CAAE,iBAAkB,EAAO,MAAM,AAAC,GAItC,GAAM,CAAE,KAAM,CAAM,CAAE,CAAG,MAAM,EAC1B,IAAI,CAAC,SACL,MAAM,CAAC,MACP,EAAE,CAAC,OAAQ,CAAC,QAAS,kBAAkB,EACtC,EAAY,IAAI,IAAY,CAAC,GAAU,EAAE,AAAF,EAAI,GAAG,CAAC,AAAC,GAAW,EAAE,EAAE,GAOrE,OANI,EAAO,MAAM,EAAE,EAAU,GAAG,CAAC,EAAO,MAAM,EAC9C,MAAM,EAAY,MAAM,IAAI,CAAC,GAAY,CACrC,KAAM,mBACN,QAAS,yBACT,SAAU,CAAE,WAAY,EAAO,SAAS,CAAE,iBAAkB,EAAO,MAAM,AAAC,CAC9E,GACO,CAAE,SAAS,EAAM,QAAS,CAAK,CAC1C,CAAE,MAAO,EAAU,CACf,MAAO,CAAE,SAAS,EAAO,MAAO,GAAK,SAAW,oCAAqC,CACzF,CACJ,CAEO,eAAe,EAAqB,CAA6B,EACpE,GAAI,CACA,IAAM,EAAW,CAAA,EAAA,EAAA,mBAAA,AAAmB,IAC9B,OAAE,CAAK,CAAE,CAAG,MAAM,EACnB,IAAI,CAAC,YACL,MAAM,CAAC,CAAE,iBAAiB,EAAM,mBAAoB,IAAI,OAAO,WAAW,EAAG,GAC7E,EAAE,CAAC,KAAM,EAAO,SAAS,EAC9B,GAAI,EAAO,MAAO,CAAE,SAAS,EAAO,MAAO,EAAM,OAAQ,AAAD,EACxD,MAAO,CAAE,SAAS,CAAK,CAC3B,CAAE,MAAO,EAAU,CACf,MAAO,CAAE,SAAS,EAAO,MAAO,GAAK,SAAW,oCAAqC,CACzF,CACJ,CAEO,eAAe,EAAoB,CAA6B,EACnE,GAAI,CACA,IAAM,EAAW,CAAA,EAAA,EAAA,mBAAA,AAAmB,IAC9B,OAAE,CAAK,CAAE,CAAG,MAAM,EACnB,IAAI,CAAC,YACL,MAAM,CAAC,CAAE,iBAAiB,EAAM,mBAAoB,IAAI,OAAO,WAAW,EAAG,GAC7E,EAAE,CAAC,KAAM,EAAO,SAAS,EAC9B,GAAI,EAAO,MAAO,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,EACzD,MAAO,CAAE,SAAS,CAAK,CAC3B,CAAE,MAAO,EAAU,CACf,MAAO,CAAE,QAAS,GAAO,MAAO,GAAK,SAAW,4CAA6C,CACjG,CACJ,iCC5IsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,sCDSA,EA2CA,EAyBA,EAqCA,EAcA,IAvHA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA2CA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAyBA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAqCA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAcA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,iKErItB,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA"}