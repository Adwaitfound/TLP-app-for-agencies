{"version":3,"sources":["../../../../.next-internal/server/app/dashboard/clients/page/actions.js%20%28server%20actions%20loader%29","../../../../app/actions/create-client.ts","../../../../app/actions/delete-client.ts"],"sourcesContent":["export {logAuditEvent as '4001860d967ff1d29143ee49c09c9bbdff4d1af8fb'} from 'ACTIONS_MODULE0'\nexport {createClientAccount as '40a8276182358e0473daf518fe2722245d125a62c6'} from 'ACTIONS_MODULE1'\nexport {deleteClient as '4093ee1a78e1b6192e9a5026676301b1f60fb07d0c'} from 'ACTIONS_MODULE2'\n","'use server'\n\nimport { createClient } from '@supabase/supabase-js'\n\ntype ClientFormData = {\n    company_name: string\n    contact_person: string\n    email: string\n    phone: string\n    address: string\n}\n\ntype ClientResult = {\n    success: boolean\n    credentials?: {\n        email: string\n        password: string\n    }\n    error?: string\n}\n\nexport async function createClientAccount(formData: ClientFormData): Promise<ClientResult> {\n    try {\n        console.log('[SERVER] createClientAccount called with:', { company_name: formData.company_name, email: formData.email })\n\n        // Validate environment variables\n        const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n        const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n        if (!url) {\n            console.error('[SERVER] Missing NEXT_PUBLIC_SUPABASE_URL')\n            return { success: false, error: 'NEXT_PUBLIC_SUPABASE_URL is not configured' }\n        }\n\n        if (!key) {\n            console.error('[SERVER] Missing SUPABASE_SERVICE_ROLE_KEY')\n            return { success: false, error: 'SUPABASE_SERVICE_ROLE_KEY is not configured' }\n        }\n\n        console.log('[SERVER] Creating admin client...')\n        const supabaseAdmin = createClient(url, key, {\n            auth: {\n                autoRefreshToken: false,\n                persistSession: false\n            }\n        })\n\n        // Generate a random password\n        const generatedPassword = Math.random().toString(36).slice(-10) + Math.random().toString(36).slice(-10).toUpperCase()\n\n        console.log('[SERVER] Checking if auth user already exists...')\n        // Check if user already exists\n        const { data: existingUser } = await supabaseAdmin.auth.admin.listUsers()\n        const userExists = existingUser?.users?.some(u => u.email === formData.email)\n\n        let userId: string\n\n        if (userExists) {\n            console.log('[SERVER] Auth user already exists, finding existing user ID...')\n            const { data: { users }, error: listError } = await supabaseAdmin.auth.admin.listUsers()\n            const existingAuthUser = users?.find(u => u.email === formData.email)\n\n            if (!existingAuthUser?.id) {\n                return { success: false, error: 'User exists but could not retrieve ID' }\n            }\n            userId = existingAuthUser.id\n            console.log('[SERVER] Using existing auth user:', userId)\n        } else {\n            console.log('[SERVER] Creating new auth user...')\n            const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({\n                email: formData.email,\n                password: generatedPassword,\n                email_confirm: true,\n                user_metadata: {\n                    full_name: formData.contact_person,\n                    role: 'client',\n                }\n            })\n\n            if (authError) {\n                console.error('[SERVER] Auth error:', authError)\n                return { success: false, error: `Auth error: ${authError.message}` }\n            }\n\n            if (!authData.user?.id) {\n                console.error('[SERVER] No user ID returned from auth')\n                return { success: false, error: 'Failed to create auth user' }\n            }\n\n            userId = authData.user.id\n            console.log('[SERVER] Auth user created:', userId)\n        }\n\n        console.log('[SERVER] Checking if user record exists...')\n        const { data: existingUserRecord } = await supabaseAdmin\n            .from('users')\n            .select('id')\n            .eq('id', userId)\n            .single()\n\n        if (!existingUserRecord) {\n            console.log('[SERVER] Inserting user record...')\n            const { error: userError } = await supabaseAdmin\n                .from('users')\n                .insert({\n                    id: userId,\n                    email: formData.email,\n                    full_name: formData.contact_person,\n                    role: 'client',\n                    status: 'approved',\n                    company_name: formData.company_name,\n                })\n\n            if (userError) {\n                console.error('[SERVER] User insert error:', userError)\n                return { success: false, error: `User insert error: ${userError.message}` }\n            }\n\n            console.log('[SERVER] User record created')\n        } else {\n            console.log('[SERVER] User record already exists')\n        }\n\n        console.log('[SERVER] Inserting client record...')\n        const { error: clientError } = await supabaseAdmin\n            .from('clients')\n            .insert([{\n                user_id: userId,\n                company_name: formData.company_name,\n                contact_person: formData.contact_person,\n                email: formData.email,\n                phone: formData.phone || '',\n                address: formData.address || '',\n                status: 'active',\n                total_projects: 0,\n                total_revenue: 0,\n            }])\n\n        if (clientError) {\n            console.error('[SERVER] Client insert error:', clientError)\n            return { success: false, error: `Client insert error: ${clientError.message}` }\n        }\n\n        console.log('[SERVER] Client record created successfully')\n        const result: ClientResult = {\n            success: true,\n            credentials: {\n                email: formData.email,\n                password: generatedPassword\n            }\n        }\n        console.log('[SERVER] Returning success result')\n        return result\n    } catch (error: any) {\n        console.error('[SERVER] Caught exception:', error?.message || String(error))\n        return {\n            success: false,\n            error: `Exception: ${error?.message || String(error)}`\n        }\n    }\n}\n","'use server'\n\nimport { createClient } from '@supabase/supabase-js'\n\ntype DeleteClientResult = {\n    success: boolean\n    error?: string\n}\n\nexport async function deleteClient(clientId: string): Promise<DeleteClientResult> {\n    try {\n        console.log('[SERVER] deleteClient called for client:', clientId)\n\n        // Validate environment variables\n        const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n        const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n        if (!url) {\n            console.error('[SERVER] Missing NEXT_PUBLIC_SUPABASE_URL')\n            return { success: false, error: 'NEXT_PUBLIC_SUPABASE_URL is not configured' }\n        }\n\n        if (!key) {\n            console.error('[SERVER] Missing SUPABASE_SERVICE_ROLE_KEY')\n            return { success: false, error: 'SUPABASE_SERVICE_ROLE_KEY is not configured' }\n        }\n\n        const supabaseAdmin = createClient(url, key, {\n            auth: {\n                autoRefreshToken: false,\n                persistSession: false\n            }\n        })\n\n        // Get the client record to find the associated user\n        const { data: clientData, error: getClientError } = await supabaseAdmin\n            .from('clients')\n            .select('user_id')\n            .eq('id', clientId)\n            .single()\n\n        if (getClientError) {\n            console.error('[SERVER] Error fetching client:', getClientError)\n            return { success: false, error: 'Client not found' }\n        }\n\n        const userId = clientData?.user_id\n\n        // Delete the client record (this will cascade delete related projects, invoices, etc.)\n        const { error: deleteClientError } = await supabaseAdmin\n            .from('clients')\n            .delete()\n            .eq('id', clientId)\n\n        if (deleteClientError) {\n            console.error('[SERVER] Error deleting client:', deleteClientError)\n            return { success: false, error: deleteClientError.message }\n        }\n\n        // If there was an associated user account, delete it too\n        if (userId) {\n            const { error: deleteUserError } = await supabaseAdmin.auth.admin.deleteUser(userId)\n            if (deleteUserError) {\n                console.error('[SERVER] Error deleting user account:', deleteUserError)\n                // Don't fail if user deletion fails, as the client is already deleted\n            }\n        }\n\n        console.log('[SERVER] Client deleted successfully:', clientId)\n        return { success: true }\n    } catch (error: any) {\n        console.error('[SERVER] Unexpected error:', error)\n        return { success: false, error: error?.message || 'An unexpected error occurred' }\n    }\n}\n"],"names":[],"mappings":"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"}