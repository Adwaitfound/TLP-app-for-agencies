{"version":3,"sources":["../../../../app/actions/data%3Ab0bf4f%20%3Ctext/javascript%3E","../../../../app/dashboard/comments/page.tsx"],"sourcesContent":["/* __next_internal_action_entry_do_not_use__ [{\"405c5bdfe2a43767b9832e1c2375adb8b49762ba71\":\"assignCommentToEmployee\"},\"app/actions/client-comments.ts\",\"\"] */\"use turbopack no side effects\";import{createServerReference,callServer,findSourceMapURL}from\"private-next-rsc-action-client-wrapper\";export var assignCommentToEmployee=/*#__PURE__*/createServerReference(\"405c5bdfe2a43767b9832e1c2375adb8b49762ba71\",callServer,void 0,findSourceMapURL,\"assignCommentToEmployee\");","\"use client\"\n\nimport { useEffect, useMemo, useState } from 'react'\nimport { createClient } from '@/lib/supabase/client'\nimport { useAuth } from '@/contexts/auth-context'\nimport { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { assignCommentToEmployee } from '@/app/actions/client-comments'\nimport { Input } from '@/components/ui/input'\n\nexport default function CommentsAdminPage() {\n    const { user } = useAuth()\n    const [comments, setComments] = useState<any[]>([])\n    const [projects, setProjects] = useState<any[]>([])\n    const [teamByProject, setTeamByProject] = useState<Record<string, any[]>>({})\n    const [assignees, setAssignees] = useState<Record<string, string>>({})\n    const [projectFilter, setProjectFilter] = useState<string>('all')\n    const [search, setSearch] = useState('')\n    const [loading, setLoading] = useState(true)\n\n    useEffect(() => {\n        async function fetchData() {\n            if (!user) return\n            const supabase = createClient()\n            setLoading(true)\n            try {\n                const { data: projectsData } = await supabase\n                    .from('projects')\n                    .select('id, name, client_id, clients(company_name)')\n                    .order('created_at', { ascending: false })\n\n                const { data: commentsData } = await supabase\n                    .from('project_comments')\n                    .select(`\n                        id,\n                        project_id,\n                        user_id,\n                        comment_text,\n                        assigned_user_id,\n                        status,\n                        created_at,\n                        author:user_id(full_name, email),\n                        assignee:assigned_user_id(full_name, email),\n                        projects(name, clients(company_name))\n                    `)\n                    .order('created_at', { ascending: false })\n                    .limit(200)\n\n                const projectIds = projectsData?.map(p => p.id) || []\n                const { data: teamRows } = await supabase\n                    .from('project_team')\n                    .select('project_id, user_id, users(full_name, email)')\n                    .in('project_id', projectIds)\n\n                const groupedTeam = (teamRows || []).reduce((acc, row) => {\n                    acc[row.project_id] = acc[row.project_id] || []\n                    acc[row.project_id].push(row)\n                    return acc\n                }, {} as Record<string, any[]>)\n\n                setProjects(projectsData || [])\n                setComments(commentsData || [])\n                setTeamByProject(groupedTeam)\n            } catch (e) {\n                console.error('Failed to fetch comments admin view', e)\n            } finally {\n                setLoading(false)\n            }\n        }\n        fetchData()\n    }, [user?.id])\n\n    const filtered = useMemo(() => {\n        return comments.filter((c) => {\n            const matchesProject = projectFilter === 'all' || c.project_id === projectFilter\n            const haystack = `${c.comment_text || ''} ${c.projects?.name || ''} ${c.author?.full_name || ''} ${c.author?.email || ''}`.toLowerCase()\n            const matchesSearch = haystack.includes(search.toLowerCase())\n            return matchesProject && matchesSearch\n        })\n    }, [comments, projectFilter, search])\n\n    const assign = async (commentId: string, userId: string) => {\n        if (!userId) return\n        const res = await assignCommentToEmployee({ commentId, userId })\n        if (res.success) {\n            setComments(prev => prev.map(c => c.id === commentId ? { ...c, assigned_user_id: userId, assignee: res.comment?.assignee } : c))\n        }\n    }\n\n    return (\n        <div className=\"space-y-4\">\n            <Card>\n                <CardHeader className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n                    <div>\n                        <CardTitle>Project Comments</CardTitle>\n                        <CardDescription>Admin/PM view of all comments across projects</CardDescription>\n                    </div>\n                    <div className=\"flex gap-2\">\n                        <Select value={projectFilter} onValueChange={setProjectFilter}>\n                            <SelectTrigger className=\"w-40\">\n                                <SelectValue placeholder=\"Filter by project\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                <SelectItem value=\"all\">All projects</SelectItem>\n                                {projects.map((p) => (\n                                    <SelectItem key={p.id} value={p.id}>{p.name}</SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                        <Input\n                            placeholder=\"Search comments or authors\"\n                            value={search}\n                            onChange={(e) => setSearch(e.target.value)}\n                            className=\"w-60\"\n                        />\n                    </div>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                    {loading ? (\n                        <p className=\"text-sm text-muted-foreground\">Loadingâ€¦</p>\n                    ) : filtered.length === 0 ? (\n                        <p className=\"text-sm text-muted-foreground\">No comments found</p>\n                    ) : (\n                        filtered.map((c) => (\n                            <div key={c.id} className=\"p-3 border rounded-lg space-y-2\">\n                                <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                                    <span>{c.author?.full_name || c.author?.email || 'Unknown user'}</span>\n                                    <span>{new Date(c.created_at).toLocaleString()}</span>\n                                </div>\n                                <div className=\"flex items-center justify-between\">\n                                    <div>\n                                        <p className=\"font-medium text-sm\">{c.projects?.name || 'Project'}</p>\n                                        <p className=\"text-xs text-muted-foreground\">{c.projects?.clients?.company_name}</p>\n                                    </div>\n                                    <span className=\"text-xs text-muted-foreground\">{c.status}</span>\n                                </div>\n                                <p className=\"text-sm\">{c.comment_text}</p>\n                                {c.assignee && (\n                                    <p className=\"text-xs text-muted-foreground\">Assigned to {c.assignee.full_name || c.assignee.email}</p>\n                                )}\n                                {teamByProject[c.project_id]?.length ? (\n                                    <div className=\"flex items-center gap-2 pt-1\">\n                                        <select\n                                            className=\"border rounded px-2 py-1 text-sm\"\n                                            value={assignees[c.id] ?? c.assigned_user_id ?? ''}\n                                            onChange={(e) => setAssignees((prev) => ({ ...prev, [c.id]: e.target.value }))}\n                                        >\n                                            <option value=\"\">Select assignee</option>\n                                            {teamByProject[c.project_id].map((m) => (\n                                                <option key={m.user_id} value={m.user_id}>{m.users?.full_name || m.users?.email || 'Member'}</option>\n                                            ))}\n                                        </select>\n                                        <Button size=\"sm\" variant=\"outline\" onClick={() => assignees[c.id] && assign(c.id, assignees[c.id])}>\n                                            Assign\n                                        </Button>\n                                    </div>\n                                ) : null}\n                            </div>\n                        ))\n                    )}\n                </CardContent>\n            </Card>\n        </div>\n    )\n}\n"],"names":[],"mappings":"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"}