{"version":3,"sources":["../../../../.next-internal/server/app/dashboard/invoices/page/actions.js%20%28server%20actions%20loader%29","../../../../app/actions/upload-invoice.ts","../../../../app/actions/invoice-operations.ts"],"sourcesContent":["export {logAuditEvent as '4001860d967ff1d29143ee49c09c9bbdff4d1af8fb'} from 'ACTIONS_MODULE0'\nexport {uploadInvoiceFile as '40f54ce617644a4784493e827870e17a65e9273ef2'} from 'ACTIONS_MODULE1'\nexport {fetchInvoicesData as '005e4c4e42c0c2763b1f47fcf35b742542a8e3595f'} from 'ACTIONS_MODULE2'\nexport {updateInvoiceStatus as '60a1647e99863c4a9ca254b5e3376492d2265241a0'} from 'ACTIONS_MODULE2'\nexport {deleteInvoice as '6080e6bd584b0a9051540e8465bc2512b088944e84'} from 'ACTIONS_MODULE2'\nexport {getSignedInvoiceUrl as '400ac50675809b5125de28467cacbc1423e833b418'} from 'ACTIONS_MODULE2'\n","\"use server\"\n\nimport { createClient, createServiceClient } from \"@/lib/supabase/server\"\n\nexport async function uploadInvoiceFile(formData: FormData) {\n    const supabase = await createClient()\n    const serviceClient = createServiceClient()\n\n    // Get current user\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\n    if (authError || !user) {\n        return { error: \"Unauthorized\" }\n    }\n\n    // Verify user is adwait\n    if (user.email !== \"adwait@thelostproject.in\") {\n        return { error: \"Access restricted to adwait@thelostproject.in\" }\n    }\n\n    const file = formData.get(\"file\") as File\n    const invoiceNumber = formData.get(\"invoiceNumber\") as string\n\n    if (!file) {\n        return { error: \"No file provided\" }\n    }\n\n    if (!file.name.toLowerCase().endsWith(\".pdf\")) {\n        return { error: \"Only PDF files are allowed\" }\n    }\n\n    try {\n        const fileName = `${invoiceNumber.replace(/[^a-zA-Z0-9]/g, \"_\")}_${Date.now()}_${Math.random().toString(36).substring(7)}.pdf`\n        const filePath = `invoices/${fileName}`\n\n        // Upload file using service client (has elevated permissions)\n        const { error: uploadError } = await serviceClient.storage\n            .from(\"project-files\")\n            .upload(filePath, file)\n\n        if (uploadError) {\n            console.error(\"Storage upload error:\", uploadError)\n            return { error: `Upload failed: ${uploadError.message}` }\n        }\n\n        // Get public URL\n        const { data: { publicUrl } } = serviceClient.storage\n            .from(\"project-files\")\n            .getPublicUrl(filePath)\n\n        return {\n            success: true,\n            filePath,\n            publicUrl,\n        }\n    } catch (error: any) {\n        console.error(\"Upload error:\", error)\n        return { error: error.message || \"Upload failed\" }\n    }\n}\n","\"use server\"\n\nimport { createClient, createServiceClient } from \"@/lib/supabase/server\"\n\nfunction extractStoragePath(fileUrl: string) {\n    const marker = \"project-files/\"\n    const idx = fileUrl.indexOf(marker)\n    const raw = idx >= 0 ? fileUrl.slice(idx + marker.length) : fileUrl\n    return raw.replace(/^public\\//, \"\").replace(/^\\//, \"\")\n}\n\nexport async function fetchInvoicesData() {\n    const supabase = await createClient()\n\n    // Get current user\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\n    if (authError || !user) {\n        return { error: \"Unauthorized\" }\n    }\n\n    // Verify user is adwait\n    if (user.email !== \"adwait@thelostproject.in\") {\n        return { error: \"Access restricted to adwait@thelostproject.in\" }\n    }\n\n    try {\n        // Fetch invoices with related data\n        const { data: invoicesData, error: invoicesError } = await supabase\n            .from(\"invoices\")\n            .select(\"*, clients(company_name), projects(name)\")\n            .order(\"created_at\", { ascending: false })\n\n        if (invoicesError) throw invoicesError\n\n        // Fetch clients\n        const { data: clientsData, error: clientsError } = await supabase\n            .from(\"clients\")\n            .select(\"*\")\n            .order(\"company_name\")\n\n        if (clientsError) throw clientsError\n\n        // Fetch projects\n        const { data: projectsData, error: projectsError } = await supabase\n            .from(\"projects\")\n            .select(\"*\")\n            .order(\"name\")\n\n        if (projectsError) throw projectsError\n\n        return {\n            invoices: invoicesData || [],\n            clients: clientsData || [],\n            projects: projectsData || [],\n        }\n    } catch (error: any) {\n        console.error(\"Fetch error:\", error)\n        return { error: error.message || \"Failed to fetch data\" }\n    }\n}\n\nexport async function updateInvoiceStatus(invoiceId: string, status: string) {\n    const supabase = await createClient()\n\n    // Get current user\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\n    if (authError || !user) {\n        return { error: \"Unauthorized\" }\n    }\n\n    // Verify user is adwait\n    if (user.email !== \"adwait@thelostproject.in\") {\n        return { error: \"Access restricted to adwait@thelostproject.in\" }\n    }\n\n    try {\n        const { data, error } = await supabase\n            .from(\"invoices\")\n            .update({ status })\n            .eq(\"id\", invoiceId)\n            .select(\"*, clients(company_name), projects(name)\")\n            .single()\n\n        if (error) throw error\n\n        return { success: true, data }\n    } catch (error: any) {\n        console.error(\"Update error:\", error)\n        return { error: error.message || \"Failed to update invoice\" }\n    }\n}\n\nexport async function deleteInvoice(invoiceId: string, fileUrl: string) {\n    const supabase = await createClient()\n    const service = createServiceClient()\n\n    // Get current user\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\n    if (authError || !user) {\n        return { error: \"Unauthorized\" }\n    }\n\n    // Verify user is adwait\n    if (user.email !== \"adwait@thelostproject.in\") {\n        return { error: \"Access restricted to adwait@thelostproject.in\" }\n    }\n\n    try {\n        // Delete file from storage\n        const path = extractStoragePath(fileUrl)\n        await service.storage.from(\"project-files\").remove([path])\n\n        // Delete from database\n        const { error } = await supabase.from(\"invoices\").delete().eq(\"id\", invoiceId)\n        if (error) throw error\n\n        return { success: true }\n    } catch (error: any) {\n        console.error(\"Delete error:\", error)\n        return { error: error.message || \"Failed to delete invoice\" }\n    }\n}\n\nexport async function getSignedInvoiceUrl(fileUrl: string) {\n    const supabase = await createClient()\n    const service = createServiceClient()\n\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\n    if (authError || !user) return { error: \"Unauthorized\" }\n    if (user.email !== \"adwait@thelostproject.in\") return { error: \"Access restricted to adwait@thelostproject.in\" }\n\n    try {\n        const path = extractStoragePath(fileUrl)\n        const { data, error } = await service.storage.from(\"project-files\").createSignedUrl(path, 3600)\n        if (error) throw error\n        return { signedUrl: data?.signedUrl }\n    } catch (error: any) {\n        console.error(\"Signed URL error:\", error)\n        return { error: error.message || \"Failed to generate signed URL\" }\n    }\n}\n"],"names":[],"mappings":"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"}