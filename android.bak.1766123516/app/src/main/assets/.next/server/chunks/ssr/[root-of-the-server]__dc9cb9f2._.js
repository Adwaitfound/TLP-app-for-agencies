module.exports=[41813,a=>{"use strict";var b=a.i(37936),c=a.i(98310);async function d(a){try{let b=(0,c.createServiceClient)(),{data:d,error:e}=await b.from("users").select("id, email, status, role").eq("email",a).limit(1).single();if(e)return{success:!1,error:e.message};let f=d?.id;if(!f){let{data:c,error:d}=await b.auth.admin.listUsers({perPage:200});if(d)return{success:!1,error:d.message};let e=c?.users?.find(b=>(b?.email||"").toLowerCase()===a.toLowerCase());if(!e?.id)return{success:!1,error:"User not found for provided email"};f=e.id}let{error:g}=await b.auth.admin.updateUserById(f,{email_confirm:!0});if(g)return{success:!1,error:g.message};return{success:!0,userId:f}}catch(a){return{success:!1,error:a?.message||"Unexpected error while confirming email"}}}(0,a.i(13095).ensureServerEntryExports)([d]),(0,b.registerServerReference)(d,"407dfc82b3267d99c51cea5a0a0ab48bad3c28a250",null),a.s(["forceConfirmEmail",()=>d])},12174,a=>{"use strict";var b=a.i(37936),c=a.i(98310),d=a.i(18558),e=a.i(74779);async function f(a){let b=await (0,c.createClient)(),{data:{user:f},error:g}=await b.auth.getUser();if(g||!f)return{error:"Unauthorized"};console.log("[createTask] Creating task for user:",f.id,f.email,"Data:",a);let h={user_id:f.id,title:a.title,description:a.description,priority:a.priority,due_date:a.due_date,estimated_hours:a.estimated_hours,project_id:a.project_id};!a.project_id&&a.proposed_project_name&&(h.proposed_project_name=a.proposed_project_name,a.proposed_project_vertical&&a.proposed_project_vertical.trim()&&(h.proposed_project_vertical=a.proposed_project_vertical),h.proposed_project_status="pending",console.log("[createTask] Setting proposed project status to pending"));let{data:i,error:j}=await b.from("employee_tasks").insert(h).select().single();return(console.log("[createTask] Result:",{task:i,error:j}),j)?(console.error("Create task error:",j),await (0,e.logAuditEvent)({action:"create",entityType:"task",entityName:a.title,status:"error",errorMessage:j.message,details:{...a}}).catch(a=>console.warn("Failed to log audit event:",a)),{error:j.message}):(await (0,e.logAuditEvent)({action:"create",entityType:"task",entityId:i.id,entityName:i.title,status:"success",newValues:{title:i.title,project_id:i.project_id,proposed_project_name:i.proposed_project_name,proposed_project_vertical:i.proposed_project_vertical,priority:i.priority},details:{description:i.description,due_date:i.due_date,is_proposal:!!i.proposed_project_name}}).catch(a=>console.warn("Failed to log audit event:",a)),(0,d.revalidatePath)("/dashboard/employee"),{data:i})}async function g(a,b){let e=await (0,c.createClient)(),{data:{user:f},error:g}=await e.auth.getUser();if(g||!f)return{error:"Unauthorized"};let h={...b};"completed"===b.status&&(h.completed_at=new Date().toISOString());let{data:i,error:j}=await e.from("employee_tasks").update(h).eq("id",a).eq("user_id",f.id).select().single();return j?(console.error("Update task error:",j),{error:j.message}):((0,d.revalidatePath)("/dashboard/employee"),{data:i})}async function h(a){console.log("[deleteTask] ðŸ”µ START - TaskID:",a);let b=await (0,c.createClient)(),{data:{user:f},error:g}=await b.auth.getUser();if(g||!f)return console.log("[deleteTask] âŒ AUTH FAILED:",g),{error:"Unauthorized"};console.log("[deleteTask] âœ… Auth user:",f.id),console.log("[deleteTask] Attempting delete from employee_tasks where id="+a+" AND user_id="+f.id);let{error:h}=await b.from("employee_tasks").delete().eq("id",a).eq("user_id",f.id);return h?(console.error("[deleteTask] âŒ Delete error:",h),await (0,e.logAuditEvent)({action:"delete",entityType:"task",entityId:a,status:"error",errorMessage:h.message}).catch(a=>console.warn("Failed to log audit event:",a)),{error:h.message}):(console.log("[deleteTask] âœ… Task deleted successfully"),await (0,e.logAuditEvent)({action:"delete",entityType:"task",entityId:a,status:"success"}).catch(a=>console.warn("Failed to log audit event:",a)),(0,d.revalidatePath)("/dashboard/employee"),console.log("[deleteTask] âœ… Path revalidated"),{success:!0})}async function i(a){let b=await (0,c.createClient)(),{data:{user:d},error:e}=await b.auth.getUser();if(e||!d)return{error:"Unauthorized"};let f=b.from("employee_tasks").select("*, projects(name)").eq("user_id",d.id).order("created_at",{ascending:!1});a?.status&&(f=f.eq("status",a.status)),a?.priority&&(f=f.eq("priority",a.priority)),a?.project_id&&(f=f.eq("project_id",a.project_id));let{data:g,error:h}=await f;return h?(console.error("Get tasks error:",h),{error:h.message}):{data:g}}async function j(){let a=await (0,c.createClient)(),{data:{user:b},error:d}=await a.auth.getUser();if(d||!b)return console.error("[getTodayTasks] Auth error:",d),{error:"Unauthorized"};console.log("[getTodayTasks] User ID:",b.id,"Email:",b.email);let{data:e,error:f}=await a.from("profiles").select("role").eq("id",b.id).single();console.log("[getTodayTasks] User role:",e?.role,"Profile error:",f),new Date().toISOString().split("T")[0];let g=a.from("employee_tasks").select("*, projects(name)"),h=e?.role==="employee";console.log("[getTodayTasks] Is employee:",h,"Will filter by user_id:",h),h&&(g=g.eq("user_id",b.id));let i=g.neq("status","completed").neq("status","cancelled"),{data:j,error:k}=await i,l=a.from("employee_tasks").select("*, projects(name)").not("proposed_project_status","is",null);h&&(l=l.eq("user_id",b.id));let{data:m,error:n}=await l,o=new Map;j?.forEach(a=>o.set(a.id,a)),m?.forEach(a=>o.set(a.id,a));let p=Array.from(o.values()).sort((a,b)=>{let c={urgent:0,high:1,medium:2,low:3},d=(c[a.priority]??2)-(c[b.priority]??2);return 0!==d?d:(a.due_date||"").localeCompare(b.due_date||"")}),q=k||n;return(console.log("[getTodayTasks] Query result: active tasks:",j?.length,"proposal tasks:",m?.length,"merged:",p.length,{error:q,data:p}),q)?(console.error("Get today tasks error:",q),{error:q.message}):{data:p}}async function k(){let a=await (0,c.createClient)(),{data:{user:b},error:d}=await a.auth.getUser();if(d||!b)return{error:"Unauthorized"};let{data:e}=await a.from("profiles").select("role").eq("id",b.id).single(),f=new Date().toISOString().split("T")[0],g=a.from("employee_tasks").select("*, projects(name)").lt("due_date",f).neq("status","completed").neq("status","cancelled");e?.role==="employee"&&(g=g.eq("user_id",b.id)),g=g.order("due_date",{ascending:!0});let{data:h,error:i}=await g;return(console.log("[getOverdueTasks] Query result:",{count:h?.length,data:h}),i)?(console.error("Get overdue tasks error:",i),{error:i.message}):{data:h}}async function l(a){let b=await (0,c.createClient)(),{data:{user:e},error:f}=await b.auth.getUser();if(f||!e)return{error:"Unauthorized"};let{data:g,error:h}=await b.from("users").select("role").eq("id",e.id).single();if(h||!g)return{error:"Failed to verify permissions"};if("admin"!==g.role&&"project_manager"!==g.role)return{error:"Only admins and project managers can assign tasks"};let i={user_id:a.employee_id,title:a.title,description:a.description,project_id:a.project_id,proposed_project_name:a.proposed_project_name,priority:a.priority||"medium",due_date:a.due_date,estimated_hours:a.estimated_hours};!a.project_id&&a.proposed_project_name&&(i.proposed_project_status="pending");let{data:j,error:k}=await b.from("employee_tasks").insert(i).select().single();return k?(console.error("Assign task error:",k),{error:k.message}):((0,d.revalidatePath)("/dashboard/employee"),{data:j})}async function m(){let a=await (0,c.createClient)(),{data:{user:b},error:d}=await a.auth.getUser();if(d||!b)return{error:"Unauthorized"};let{data:e,error:f}=await a.from("users").select("role").eq("id",b.id).single();if(f||!e||"admin"!==e.role&&"project_manager"!==e.role)return{error:"Only admins and project managers can view proposals"};let{data:g,error:h}=await a.from("employee_tasks").select("id, title, description, proposed_project_name, proposed_project_vertical, proposed_project_status, proposed_project_notes, user_id, created_at, users:users!employee_tasks_user_id_fkey(full_name, email), project_id, projects(name)").not("proposed_project_name","is",null).eq("proposed_project_status","pending").order("created_at",{ascending:!1});return h?(console.error("Get pending proposals error:",h),{error:h.message}):{data:g}}async function n(a){console.log("[reviewProjectProposal] ðŸ”µ START - Decision:",a.decision,"TaskID:",a.taskId,"ProjectID:",a.projectId);let b=await (0,c.createClient)(),{data:{user:f},error:g}=await b.auth.getUser();if(g||!f)return console.log("[reviewProjectProposal] âŒ AUTH FAILED:",g),{error:"Unauthorized"};console.log("[reviewProjectProposal] âœ… Auth user:",f.id,f.email);let{data:h,error:i}=await b.from("users").select("role").eq("id",f.id).single();if(i||!h||"admin"!==h.role&&"project_manager"!==h.role)return console.log("[reviewProjectProposal] âŒ ROLE CHECK FAILED:",h?.role),{error:"Only admins and project managers can review proposals"};console.log("[reviewProjectProposal] âœ… Role check passed:",h.role);let j={proposed_project_status:a.decision,proposed_project_reviewed_by:f.id,proposed_project_reviewed_at:new Date().toISOString(),proposed_project_notes:a.notes};if("approved"!==a.decision||a.projectId)a.projectId&&"approved"===a.decision&&(console.log("[reviewProjectProposal] ðŸ”· Linking existing project:",a.projectId),j.project_id=a.projectId);else{console.log("[reviewProjectProposal] ðŸ”· CREATING NEW PROJECT FROM PROPOSAL");let{data:c,error:d}=await b.from("employee_tasks").select("proposed_project_name, proposed_project_vertical, user_id").eq("id",a.taskId).single();if(console.log("[reviewProjectProposal] Task fetch:",{error:d,task:c}),d||!c)return console.log("[reviewProjectProposal] âŒ TASK FETCH FAILED"),{error:"Failed to fetch task details"};console.log("[reviewProjectProposal] âœ… Task fetched - Name:",c.proposed_project_name,"Vertical:",c.proposed_project_vertical,"Employee:",c.user_id),console.log("[reviewProjectProposal] ðŸ”¶ Attempting to create project with:",{name:c.proposed_project_name,service_type:c.proposed_project_vertical||"video_production",status:"planning",created_by:f.id});let{data:e,error:g}=await b.from("projects").insert({name:c.proposed_project_name,service_type:c.proposed_project_vertical||"video_production",status:"planning",progress_percentage:0,created_by:f.id}).select().single();if(console.log("[reviewProjectProposal] Project insert result:",{error:g,newProject:e}),g)console.error("[reviewProjectProposal] âŒ Project creation failed:",g);else if(e){console.log("[reviewProjectProposal] âœ… Project created successfully! ID:",e.id),j.project_id=e.id,console.log("[reviewProjectProposal] Updated updateData.project_id =",e.id),console.log("[reviewProjectProposal] ðŸ”· Adding team members to project:",e.id),console.log("[reviewProjectProposal] Team members to add:",[{project_id:e.id,user_id:f.id,role:"Admin who approved"},{project_id:e.id,user_id:c.user_id,role:"Employee who requested"}]);try{let a=[{project_id:e.id,user_id:f.id},{project_id:e.id,user_id:c.user_id}],{error:d,data:g}=await b.from("project_team").insert(a).select();console.log("[reviewProjectProposal] Team insert result:",{error:d,data:g}),d?console.error("[reviewProjectProposal] âŒ Failed to add team members:",d):console.log("[reviewProjectProposal] âœ… Team members added successfully! Rows:",g?.length)}catch(a){console.error("[reviewProjectProposal] âŒ Error adding team members:",a)}}}let{data:k,error:l}=await b.from("employee_tasks").update(j).eq("id",a.taskId).select().single();return l?(console.error("Review proposal error:",l),await (0,e.logAuditEvent)({action:"approved"===a.decision?"approve":"reject",entityType:"proposal",entityId:a.taskId,status:"error",errorMessage:l.message,details:{decision:a.decision,notes:a.notes}}).catch(a=>console.warn("Failed to log audit event:",a)),{error:l.message}):(await (0,e.logAuditEvent)({action:"approved"===a.decision?"approve":"reject",entityType:"proposal",entityId:a.taskId,status:"success",newValues:j,details:{decision:a.decision,notes:a.notes,project_created:!!k?.project_id}}).catch(a=>console.warn("Failed to log audit event:",a)),(0,d.revalidatePath)("/dashboard"),(0,d.revalidatePath)("/dashboard/employee"),{data:k})}async function o(){let a=await (0,c.createClient)(),{data:{user:b},error:d}=await a.auth.getUser();if(d||!b)return{error:"Unauthorized"};let{data:e,error:f}=await a.from("employee_tasks").select("id, title, status, proposed_project_name, proposed_project_status, user_id, created_at").eq("user_id",b.id).order("created_at",{ascending:!1});return console.log("[debugAllUserTasks] ALL tasks for user",b.id,":",{count:e?.length,data:e,error:f}),{data:e,error:f}}(0,a.i(13095).ensureServerEntryExports)([f,g,h,i,j,k,l,m,n,o]),(0,b.registerServerReference)(f,"407077dfde7a116ae486d76ab40cd50a1dba0a0bf7",null),(0,b.registerServerReference)(g,"609962e915a2b373a08c0bbbfedde9f0e153e565b9",null),(0,b.registerServerReference)(h,"405aa6ef311de4fc1dcf524a8ec77eb1514a4cd5e6",null),(0,b.registerServerReference)(i,"4005c92c92793a6cdcf2992cca2f7920a73225cb9b",null),(0,b.registerServerReference)(j,"00572e83ec2be9ea7f5328beb33ed7049696a51b55",null),(0,b.registerServerReference)(k,"002677cfdd008f5d83d9c5f60a6f9cdb9be67678b3",null),(0,b.registerServerReference)(l,"409cac7e63710b9d885989455fe9fad0065b4971f9",null),(0,b.registerServerReference)(m,"007163947d433d843264fed73bf0ea0724f9038f13",null),(0,b.registerServerReference)(n,"40e9debad081e2ea61fef36767d769afdc486d2864",null),(0,b.registerServerReference)(o,"00995edc5ae2f76a60dad78039c98a527d1aecbba6",null),a.s(["createTask",()=>f,"deleteTask",()=>h,"getOverdueTasks",()=>k,"getTodayTasks",()=>j,"reviewProjectProposal",()=>n,"updateTask",()=>g])},10184,a=>{"use strict";var b=a.i(74779),c=a.i(12174),d=a.i(37936),e=a.i(98310),f=a.i(13095);async function g(a){let{userId:b,decision:c}=a;try{let a=(0,e.createServiceClient)(),{data:d,error:f}=await a.from("users").select("id, email, full_name, role, company_name, status").eq("id",b).single();if(f||!d)return{success:!1,error:"User not found or cannot be fetched"};let{error:g}=await a.from("users").update({status:c}).eq("id",b);if(g)return{success:!1,error:g.message};if("approved"===c&&"client"===d.role){let{data:c,error:e}=await a.from("clients").select("id").eq("user_id",b).maybeSingle();if(!e&&!c){let c=d.company_name||d.full_name||d.email,e=d.full_name||d.email,{error:f}=await a.from("clients").insert({user_id:b,company_name:c,contact_person:e,email:d.email,phone:null,address:"",status:"active",total_projects:0,total_revenue:0});if(f)return{success:!1,error:`Client creation failed: ${f.message}`}}}return{success:!0}}catch(a){return{success:!1,error:a?.message||"Unexpected error approving user"}}}async function h(a){if(!a||!a.includes("@"))return{success:!1,error:"Provide a valid email."};try{let b=(0,e.createServiceClient)(),{data:c,error:d}=await b.from("users").select("id, email, role, status").eq("email",a).maybeSingle();if(d)return{success:!1,error:d.message};if(!c)return{success:!1,error:"No user found for that email."};let{error:f}=await b.from("users").update({role:"admin",status:"approved"}).eq("id",c.id);if(f)return{success:!1,error:f.message};return{success:!0}}catch(a){return{success:!1,error:a?.message||"Unexpected error"}}}(0,f.ensureServerEntryExports)([g]),(0,d.registerServerReference)(g,"407d00f69ec1463aaf4cba7dfeb078331c034b7beb",null),(0,f.ensureServerEntryExports)([h]),(0,d.registerServerReference)(h,"40562833b8610881280abfc4553d749f1e50b42e3d",null);var i=a.i(41813);a.s([],9580),a.i(9580),a.s(["4001860d967ff1d29143ee49c09c9bbdff4d1af8fb",()=>b.logAuditEvent,"40562833b8610881280abfc4553d749f1e50b42e3d",()=>h,"407d00f69ec1463aaf4cba7dfeb078331c034b7beb",()=>g,"407dfc82b3267d99c51cea5a0a0ab48bad3c28a250",()=>i.forceConfirmEmail,"40e9debad081e2ea61fef36767d769afdc486d2864",()=>c.reviewProjectProposal],10184)},85685,a=>{a.v(b=>Promise.all(["server/chunks/ssr/[externals]_crypto_c412f66b._.js"].map(b=>a.l(b))).then(()=>b(54799)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__dc9cb9f2._.js.map