module.exports=[39239,a=>{"use strict";var b=a.i(5050),c=(0,b.createServerReference)("405c5bdfe2a43767b9832e1c2375adb8b49762ba71",b.callServer,void 0,b.findSourceMapURL,"assignCommentToEmployee");a.s(["assignCommentToEmployee",()=>c])},33087,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(69240),e=a.i(38422),f=a.i(3130),g=a.i(40695),h=a.i(87682),i=a.i(39239),j=a.i(5522);function k(){let{user:a}=(0,e.useAuth)(),[k,l]=(0,c.useState)([]),[m,n]=(0,c.useState)([]),[o,p]=(0,c.useState)({}),[q,r]=(0,c.useState)({}),[s,t]=(0,c.useState)("all"),[u,v]=(0,c.useState)(""),[w,x]=(0,c.useState)(!0);(0,c.useEffect)(()=>{!async function(){if(!a)return;let b=(0,d.createClient)();x(!0);try{let{data:a}=await b.from("projects").select("id, name, client_id, clients(company_name)").order("created_at",{ascending:!1}),{data:c}=await b.from("project_comments").select(`
                        id,
                        project_id,
                        user_id,
                        comment_text,
                        assigned_user_id,
                        status,
                        created_at,
                        author:user_id(full_name, email),
                        assignee:assigned_user_id(full_name, email),
                        projects(name, clients(company_name))
                    `).order("created_at",{ascending:!1}).limit(200),d=a?.map(a=>a.id)||[],{data:e}=await b.from("project_team").select("project_id, user_id, users(full_name, email)").in("project_id",d),f=(e||[]).reduce((a,b)=>(a[b.project_id]=a[b.project_id]||[],a[b.project_id].push(b),a),{});n(a||[]),l(c||[]),p(f)}catch(a){console.error("Failed to fetch comments admin view",a)}finally{x(!1)}}()},[a?.id]);let y=(0,c.useMemo)(()=>k.filter(a=>{let b="all"===s||a.project_id===s,c=`${a.comment_text||""} ${a.projects?.name||""} ${a.author?.full_name||""} ${a.author?.email||""}`.toLowerCase().includes(u.toLowerCase());return b&&c}),[k,s,u]),z=async(a,b)=>{if(!b)return;let c=await (0,i.assignCommentToEmployee)({commentId:a,userId:b});c.success&&l(d=>d.map(d=>d.id===a?{...d,assigned_user_id:b,assignee:c.comment?.assignee}:d))};return(0,b.jsx)("div",{className:"space-y-4",children:(0,b.jsxs)(f.Card,{children:[(0,b.jsxs)(f.CardHeader,{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(f.CardTitle,{children:"Project Comments"}),(0,b.jsx)(f.CardDescription,{children:"Admin/PM view of all comments across projects"})]}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsxs)(h.Select,{value:s,onValueChange:t,children:[(0,b.jsx)(h.SelectTrigger,{className:"w-40",children:(0,b.jsx)(h.SelectValue,{placeholder:"Filter by project"})}),(0,b.jsxs)(h.SelectContent,{children:[(0,b.jsx)(h.SelectItem,{value:"all",children:"All projects"}),m.map(a=>(0,b.jsx)(h.SelectItem,{value:a.id,children:a.name},a.id))]})]}),(0,b.jsx)(j.Input,{placeholder:"Search comments or authors",value:u,onChange:a=>v(a.target.value),className:"w-60"})]})]}),(0,b.jsx)(f.CardContent,{className:"space-y-3",children:w?(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loadingâ€¦"}):0===y.length?(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"No comments found"}):y.map(a=>(0,b.jsxs)("div",{className:"p-3 border rounded-lg space-y-2",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[(0,b.jsx)("span",{children:a.author?.full_name||a.author?.email||"Unknown user"}),(0,b.jsx)("span",{children:new Date(a.created_at).toLocaleString()})]}),(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"font-medium text-sm",children:a.projects?.name||"Project"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:a.projects?.clients?.company_name})]}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:a.status})]}),(0,b.jsx)("p",{className:"text-sm",children:a.comment_text}),a.assignee&&(0,b.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Assigned to ",a.assignee.full_name||a.assignee.email]}),o[a.project_id]?.length?(0,b.jsxs)("div",{className:"flex items-center gap-2 pt-1",children:[(0,b.jsxs)("select",{className:"border rounded px-2 py-1 text-sm",value:q[a.id]??a.assigned_user_id??"",onChange:b=>r(c=>({...c,[a.id]:b.target.value})),children:[(0,b.jsx)("option",{value:"",children:"Select assignee"}),o[a.project_id].map(a=>(0,b.jsx)("option",{value:a.user_id,children:a.users?.full_name||a.users?.email||"Member"},a.user_id))]}),(0,b.jsx)(g.Button,{size:"sm",variant:"outline",onClick:()=>q[a.id]&&z(a.id,q[a.id]),children:"Assign"})]}):null]},a.id))})]})})}a.s(["default",()=>k])}];

//# sourceMappingURL=app_b0806846._.js.map