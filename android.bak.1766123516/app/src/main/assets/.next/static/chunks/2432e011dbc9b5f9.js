(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,95468,e=>{"use strict";let t=(0,e.i(75254).default)("circle-check",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);e.s(["CheckCircle2",()=>t],95468)},84762,e=>{"use strict";var t=e.i(43476),s=e.i(71645),a=e.i(47163);let r=s.forwardRef(({className:e,...s},r)=>(0,t.jsx)("textarea",{className:(0,a.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),ref:r,...s}));r.displayName="Textarea",e.s(["Textarea",()=>r])},6234,e=>{"use strict";var t=e.i(95187),s=(0,t.createServerReference)("405c5bdfe2a43767b9832e1c2375adb8b49762ba71",t.callServer,void 0,t.findSourceMapURL,"assignCommentToEmployee");e.s(["assignCommentToEmployee",()=>s])},78894,e=>{"use strict";let t=(0,e.i(75254).default)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);e.s(["AlertTriangle",()=>t],78894)},62379,e=>{"use strict";var t=e.i(43476),s=e.i(71645),a=e.i(18566),r=e.i(70065),i=e.i(67881),n=e.i(84762),c=e.i(40160),l=e.i(95468),d=e.i(78894),o=e.i(20755),m=e.i(61668),u=e.i(95187),x=(0,u.createServerReference)("40a6382be664f50ea66fe39a98d1462f3f57004b5a",u.callServer,void 0,u.findSourceMapURL,"createProjectComment"),p=(0,u.createServerReference)("40bb02f9168fd9109458766923437b569718746a1e",u.callServer,void 0,u.findSourceMapURL,"listProjectComments"),h=(0,u.createServerReference)("4057388ae1c8d7ff911fc03a5fdfae99a64813f401",u.callServer,void 0,u.findSourceMapURL,"clientApproveProject"),f=e.i(6234);function j(){let{id:e}=(0,a.useParams)();(0,a.useRouter)();let{user:u}=(0,m.useAuth)(),[j,g]=(0,s.useState)(null),[v,b]=(0,s.useState)([]),[C,y]=(0,s.useState)([]),[S,w]=(0,s.useState)([]),[_,N]=(0,s.useState)([]),[k,T]=(0,s.useState)({}),[A,R]=(0,s.useState)(""),[D,U]=(0,s.useState)(null),[L,M]=(0,s.useState)([]),[P,B]=(0,s.useState)(!1),[z,q]=(0,s.useState)(null),[E,I]=(0,s.useState)(!1),[H,O]=(0,s.useState)(!0);(0,s.useEffect)(()=>{!async function(){if(!u||!e)return;let t=(0,o.createClient)();try{let{data:s,error:a}=await t.from("projects").select("*, clients(company_name)").eq("id",e).single();if(a)throw a;g(s);let{data:r}=await t.from("project_files").select("*").eq("project_id",e).order("created_at",{ascending:!1});b(r||[]);let{data:i}=await t.from("invoices").select("*").eq("project_id",e).order("due_date",{ascending:!0});y(i||[]);let n=(i||[]).some(e=>"paid"!==e.status&&e.due_date&&new Date(e.due_date).getTime()<Date.now()-2592e6);I(n);let c=await p(e);c.success&&w(c.comments||[])}catch(e){console.error("Client project fetch failed:",e?.message)}finally{O(!1)}}()},[e,u?.id]);let K=async()=>{q(null),B(!0);try{let t=A.trim();if(!t){q("Please add a comment before submitting"),B(!1);return}let s=await x({projectId:e,authorUserId:u.id,text:t});if(s.success){let t=await p(e);t.success?w(t.comments||[]):w(e=>[s.comment,...e]),R(""),M([])}s.success||q(s.error||"Could not submit comment")}catch(e){console.error("Submit comment failed:",e?.message),q(e?.message||"Unexpected error submitting comment")}finally{B(!1)}},V=async()=>{(await h({projectId:e})).success&&g(e=>({...e,client_approved:!0,client_approved_at:new Date().toISOString()}))},F=async(e,t)=>{if(!t)return;let s=await (0,f.assignCommentToEmployee)({commentId:e,userId:t});s.success&&w(a=>a.map(a=>a.id===e?{...a,assigned_user_id:t,assignee:s.comment?.assignee}:a))};return H||!j?(0,t.jsx)("div",{className:"flex items-center justify-center h-96",children:(0,t.jsx)("p",{className:"text-muted-foreground",children:"Loadingâ€¦"})}):(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)(r.Card,{children:[(0,t.jsxs)(r.CardHeader,{children:[(0,t.jsx)(r.CardTitle,{children:j.name}),(0,t.jsx)(r.CardDescription,{children:j.clients?.company_name})]}),(0,t.jsxs)(r.CardContent,{children:[E&&(0,t.jsxs)("div",{className:"p-3 rounded-md bg-destructive/10 border border-destructive/20 mb-4 flex items-center gap-2",children:[(0,t.jsx)(d.AlertTriangle,{className:"h-4 w-4 text-destructive"}),(0,t.jsx)("p",{className:"text-sm text-destructive",children:"Access restricted: invoice overdue by 30+ days. Please settle dues to continue."})]}),(0,t.jsx)("div",{className:"space-y-3",children:0===v.length?(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"No files yet"}):v.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-medium text-sm",children:e.file_name}),(0,t.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Uploaded ",new Date(e.created_at).toLocaleString()]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(i.Button,{size:"sm",variant:"outline",disabled:E,onClick:()=>window.open(e.file_url,"_blank","noopener"),children:"View"}),(0,t.jsx)(i.Button,{size:"sm",variant:"ghost",disabled:E,onClick:()=>window.open(e.file_url,"_blank","noopener"),children:(0,t.jsx)(c.Download,{className:"h-4 w-4"})})]})]},e.id))})]})]}),(0,t.jsxs)(r.Card,{children:[(0,t.jsxs)(r.CardHeader,{children:[(0,t.jsx)(r.CardTitle,{children:"Comments"}),(0,t.jsx)(r.CardDescription,{children:"Leave change requests or feedback. Admins are notified."})]}),(0,t.jsxs)(r.CardContent,{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Textarea,{placeholder:"Type your comment",value:A,onChange:e=>R(e.target.value)}),(0,t.jsx)("div",{className:"flex gap-2",children:(0,t.jsx)(i.Button,{size:"sm",onClick:K,disabled:P||!A.trim(),children:P?"Submittingâ€¦":"Submit"})}),z&&(0,t.jsx)("p",{className:"text-xs text-destructive",children:z})]}),(0,t.jsx)("div",{className:"space-y-3",children:0===S.length?(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"No comments yet"}):S.map(e=>(0,t.jsxs)("div",{className:"p-3 border rounded-lg space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[(0,t.jsx)("span",{children:e.author?.full_name||e.author?.email||"Unknown user"}),(0,t.jsx)("span",{children:new Date(e.created_at).toLocaleString()})]}),(0,t.jsx)("p",{className:"text-sm",children:e.comment_text}),e.assignee&&(0,t.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Assigned to ",e.assignee.full_name||e.assignee.email]}),(u?.role==="admin"||u?.role==="project_manager")&&_.length>0&&(0,t.jsxs)("div",{className:"flex items-center gap-2 pt-1",children:[(0,t.jsxs)("select",{className:"border rounded px-2 py-1 text-sm",value:k[e.id]??e.assigned_user_id??"",onChange:t=>T(s=>({...s,[e.id]:t.target.value})),children:[(0,t.jsx)("option",{value:"",children:"Select assignee"}),_.map(e=>(0,t.jsx)("option",{value:e.user_id,children:e.users?.full_name||e.users?.email||"Member"},e.user_id))]}),(0,t.jsx)(i.Button,{size:"sm",variant:"outline",onClick:()=>k[e.id]&&F(e.id,k[e.id]),children:"Assign"})]})]},e.id))})]})]}),(0,t.jsxs)(r.Card,{children:[(0,t.jsxs)(r.CardHeader,{children:[(0,t.jsx)(r.CardTitle,{children:"Approval"}),(0,t.jsx)(r.CardDescription,{children:"Approve the project when ready."})]}),(0,t.jsx)(r.CardContent,{children:j.client_approved?(0,t.jsxs)("div",{className:"flex items-center gap-2 text-green-600",children:[(0,t.jsx)(l.CheckCircle2,{className:"h-5 w-5"})," Approved on ",new Date(j.client_approved_at).toLocaleString()]}):(0,t.jsxs)(i.Button,{onClick:V,children:[(0,t.jsx)(l.CheckCircle2,{className:"h-4 w-4 mr-1"})," Mark Approved"]})})]})]})}e.s(["default",()=>j],62379)}]);